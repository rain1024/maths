<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√†i To√°n R√∫t Bi - Minh H·ªça T∆∞∆°ng T√°c</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .problem {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .input-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .input-group {
            margin: 10px 0;
        }
        label {
            display: inline-block;
            width: 200px;
            font-weight: bold;
        }
        input {
            padding: 8px;
            width: 100px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }
        button:hover {
            background: #45a049;
        }
        .result-visualization-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .result {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .result h2 {
            color: #4CAF50;
            margin-top: 0;
        }
        .visualization {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        @media (max-width: 1400px) {
            .result-visualization-container {
                grid-template-columns: 1fr;
            }
        }
        @media (max-width: 768px) {
            body {
                max-width: 100%;
                padding: 10px;
            }
            .ball-row {
                grid-template-columns: 60px repeat(auto-fit, 30px);
            }
            .ball {
                width: 25px;
                height: 25px;
                font-size: 10px;
            }
        }
        .ball-group {
            margin: 15px 0;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 4px;
        }
        .ball-group-header {
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
        }
        .balls {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .ball-row {
            display: grid;
            grid-template-columns: 80px repeat(auto-fit, 35px);
            gap: 5px;
            align-items: center;
            margin-bottom: 5px;
        }
        .ball-row-label {
            font-weight: bold;
            color: #555;
            text-align: right;
            padding-right: 10px;
        }
        .ball {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
            flex-shrink: 0;
        }
        .ball.drawn {
            background: #f44336;
        }
        .ball.available {
            background: #2196F3;
        }
        .explanation {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
            border-left: 4px solid #2196F3;
        }
        .step {
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 4px;
            position: relative;
            transition: all 0.3s ease;
        }
        .step.playing {
            background: #fff9c4;
            border-left: 4px solid #FFC107;
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
        }
        .step-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .play-btn {
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s;
        }
        .play-btn:hover {
            background: #45a049;
            transform: scale(1.1);
        }
        .play-btn:active {
            transform: scale(0.95);
        }
        .step-animation {
            margin-top: 10px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 4px;
            display: none;
        }
        .step-animation.active {
            display: block;
            animation: slideDown 0.3s ease;
        }
        @keyframes slideDown {
            from {
                opacity: 0;
                max-height: 0;
                padding: 0;
            }
            to {
                opacity: 1;
                max-height: 500px;
                padding: 10px;
            }
        }
        .ball.highlight {
            animation: pulse 0.5s ease;
        }
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.3);
                box-shadow: 0 0 10px rgba(76, 175, 80, 0.8);
            }
        }
        .formula {
            font-family: 'Courier New', monospace;
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .problem-illustration {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .ball.target {
            background: #333;
            position: relative;
        }
        .ball.target::after {
            content: '?';
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            background: #FF9800;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            white-space: nowrap;
        }
        .ball.normal {
            background: #9E9E9E;
        }
        .method-selector {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .method-btn {
            padding: 10px 20px;
            border: 2px solid #4CAF50;
            background: white;
            color: #4CAF50;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        .method-btn:hover {
            background: #e8f5e9;
        }
        .method-btn.active {
            background: #4CAF50;
            color: white;
        }
        .method-description {
            background: #fff3cd;
            padding: 15px;
            border-radius: 4px;
            border-left: 4px solid #ffc107;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <h1>B√†i To√°n R√∫t Bi - Minh H·ªça T∆∞∆°ng T√°c</h1>

    <div class="problem">
        <h2>ƒê·ªÅ B√†i</h2>
        <p id="problem-text">Trong m·ªôt h·ªôp c√≥ 1 vi√™n bi s·ªë 1; 2 vi√™n bi s·ªë 2; 3 vi√™n bi s·ªë 3; ...; <strong>15</strong> vi√™n bi s·ªë <strong>15</strong>.</p>
        <p id="question-text">Ch√∫ng ta r√∫t bi t·ª´ h·ªôp m√† kh√¥ng nh√¨n. H·ªèi ph·∫£i r√∫t √≠t nh·∫•t bao nhi√™u vi√™n bi ƒë·ªÉ ch·∫Øc ch·∫Øn trong s·ªë c√°c vi√™n bi ƒë√£ r√∫t c√≥ <strong>10</strong> vi√™n bi c√πng s·ªë?</p>
    </div>

    <div class="input-section">
        <h2>Tham S·ªë ƒê·∫ßu V√†o</h2>
        <div class="input-group">
            <label>S·ªë t·ªëi ƒëa (n):</label>
            <input type="number" id="n" value="15" min="1" max="30" oninput="updateProblem()">
        </div>
        <div class="input-group">
            <label>S·ªë bi c√πng lo·∫°i c·∫ßn c√≥ (k):</label>
            <input type="number" id="k" value="10" min="1" oninput="updateProblem()">
        </div>
        <button onclick="calculate()">T√≠nh To√°n & Minh H·ªça</button>
    </div>

    <div id="problem-illustration" class="problem-illustration">
        <h2>Minh H·ªça ƒê·ªÅ B√†i</h2>
        <p style="color: #666; margin-bottom: 15px;">
            <strong>Bi x√°m:</strong> T·∫•t c·∫£ bi trong h·ªôp |
            <strong>Bi ƒëen (?):</strong> C·∫ßn t√¨m k vi√™n bi c√πng s·ªë
        </p>
        <div id="initial-balls"></div>
    </div>

    <div id="result-container" style="display:none;">
        <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h2 style="color: #4CAF50; margin-top: 0;">K·∫øt Qu·∫£</h2>
            <p id="answer"></p>

            <div class="method-selector">
                <button class="method-btn active" onclick="selectMethod(1)">Ph∆∞∆°ng √Ån 1: Nguy√™n L√Ω Dirichlet</button>
                <button class="method-btn" onclick="selectMethod(2)">Ph∆∞∆°ng √Ån 2: Ph√¢n T√≠ch T·ª´ng Nh√≥m</button>
                <button class="method-btn" onclick="selectMethod(3)">Ph∆∞∆°ng √Ån 3: C√¥ng Th·ª©c T·ªïng Qu√°t</button>
                <button class="method-btn" onclick="selectMethod(4)">Ph∆∞∆°ng √Ån 4: ƒê·∫øm Ph·∫ßn B√π</button>
            </div>
        </div>

        <div class="result-visualization-container">
            <div class="result">
                <div class="explanation">
                    <div id="method-description" class="method-description"></div>
                    <h3>Gi·∫£i Th√≠ch Chi Ti·∫øt:</h3>
                    <div id="steps"></div>
                </div>
            </div>

            <div class="visualization">
                <h2>Minh H·ªça</h2>
                <div id="balls-container"></div>
            </div>
        </div>
    </div>

    <script>
        let currentMethod = 1;

        function selectMethod(method) {
            currentMethod = method;

            // Update button states
            document.querySelectorAll('.method-btn').forEach((btn, index) => {
                if (index + 1 === method) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            // Recalculate with new method
            const n = parseInt(document.getElementById('n').value);
            const k = parseInt(document.getElementById('k').value);
            generateExplanation(n, k, method);
        }

        function updateProblem() {
            const n = parseInt(document.getElementById('n').value) || 1;
            const k = parseInt(document.getElementById('k').value) || 1;

            // Update problem statement
            document.getElementById('problem-text').innerHTML =
                `Trong m·ªôt h·ªôp c√≥ 1 vi√™n bi s·ªë 1; 2 vi√™n bi s·ªë 2; 3 vi√™n bi s·ªë 3; ...; <strong>${n}</strong> vi√™n bi s·ªë <strong>${n}</strong>.`;

            document.getElementById('question-text').innerHTML =
                `Ch√∫ng ta r√∫t bi t·ª´ h·ªôp m√† kh√¥ng nh√¨n. H·ªèi ph·∫£i r√∫t √≠t nh·∫•t bao nhi√™u vi√™n bi ƒë·ªÉ ch·∫Øc ch·∫Øn trong s·ªë c√°c vi√™n bi ƒë√£ r√∫t c√≥ <strong>${k}</strong> vi√™n bi c√πng s·ªë?`;

            // Update initial illustration
            illustrateProblem(n, k);
        }

        function illustrateProblem(n, k) {
            const container = document.getElementById('initial-balls');
            container.innerHTML = '';

            const ballsDiv = document.createElement('div');
            ballsDiv.className = 'balls';

            for (let num = 1; num <= n; num++) {
                const row = document.createElement('div');
                row.className = 'ball-row';

                const label = document.createElement('span');
                label.className = 'ball-row-label';
                label.textContent = `S·ªë ${num}:`;
                row.appendChild(label);

                for (let i = 0; i < num; i++) {
                    const ball = document.createElement('div');
                    ball.className = 'ball';

                    // First k balls of numbers >= k are marked as target (black with ?)
                    if (num >= k && i < k) {
                        ball.className = 'ball target';
                        if (i === 0) {
                            // Add label only on first ball
                            ball.style.position = 'relative';
                        }
                    } else {
                        ball.className = 'ball normal';
                    }

                    ball.textContent = num;
                    row.appendChild(ball);
                }
                ballsDiv.appendChild(row);
            }

            container.appendChild(ballsDiv);
        }

        function solve(n, k) {
            let worstCase = 0;

            // Numbers 1 to (k-1) can never have k balls
            for (let i = 1; i < k; i++) {
                worstCase += i;
            }

            // Numbers k to n can have k or more balls
            let numbersWithEnoughBalls = n - k + 1;
            worstCase += numbersWithEnoughBalls * (k - 1);

            // One more ball
            worstCase += 1;

            return worstCase;
        }

        let stepCounter = 0;

        function createStep(title, content, animationContent = '', ballsToHighlight = {}) {
            stepCounter++;
            const stepId = `step-${stepCounter}`;
            let html = `<div class="step" id="${stepId}" data-balls='${JSON.stringify(ballsToHighlight)}'>`;
            html += `<div class="step-header">`;
            html += `<strong>${title}</strong>`;
            html += `<button class="play-btn" onclick="playStep('${stepId}')" title="Xem animation">‚ñ∂</button>`;
            html += `</div>`;
            html += `<div class="step-content">${content}</div>`;
            if (animationContent) {
                html += `<div class="step-animation" id="${stepId}-animation">${animationContent}</div>`;
            }
            html += `</div>`;
            return html;
        }

        function playStep(stepId) {
            // Remove playing class from all steps
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('playing');
            });

            // Add playing class to current step
            const step = document.getElementById(stepId);
            if (step) {
                step.classList.add('playing');

                // Toggle animation content
                const animation = document.getElementById(stepId + '-animation');
                if (animation) {
                    animation.classList.toggle('active');
                }

                // Scroll to step
                step.scrollIntoView({ behavior: 'smooth', block: 'center' });

                // Highlight balls in visualization based on step
                highlightBallsForStep(stepId);

                // Remove playing class after 3 seconds
                setTimeout(() => {
                    step.classList.remove('playing');
                }, 3000);
            }
        }

        function highlightBallsForStep(stepId) {
            // Remove all highlights
            document.querySelectorAll('.ball.highlight').forEach(ball => {
                ball.classList.remove('highlight');
            });

            // Get ball configuration from step data
            const step = document.getElementById(stepId);
            if (!step) return;

            const ballsConfig = JSON.parse(step.getAttribute('data-balls') || '{}');

            // If no specific config, don't highlight anything
            if (Object.keys(ballsConfig).length === 0) return;

            // Highlight specific balls based on config
            const allBallRows = document.querySelectorAll('#balls-container .ball-row');
            let delay = 0;

            allBallRows.forEach(row => {
                const label = row.querySelector('.ball-row-label');
                if (!label) return;

                const numMatch = label.textContent.match(/S·ªë (\d+):/);
                if (!numMatch) return;

                const num = parseInt(numMatch[1]);
                const balls = row.querySelectorAll('.ball');

                // Check if this number should be highlighted
                if (ballsConfig.numbers && ballsConfig.numbers.includes(num)) {
                    // Highlight specific count or all
                    const count = ballsConfig.count || balls.length;
                    balls.forEach((ball, index) => {
                        if (index < count) {
                            setTimeout(() => {
                                ball.classList.add('highlight');
                                setTimeout(() => ball.classList.remove('highlight'), 500);
                            }, delay);
                            delay += 30;
                        }
                    });
                } else if (ballsConfig.range) {
                    // Highlight range of numbers
                    const [start, end] = ballsConfig.range;
                    if (num >= start && num <= end) {
                        if (ballsConfig.count === -1) {
                            // Special case: highlight the REMAINING balls (balls that can be left)
                            // For number with 'num' balls, if we draw k-1, the remaining are from index k-1 to end
                            const k = parseInt(document.getElementById('k').value);
                            balls.forEach((ball, index) => {
                                if (index >= k - 1) { // Highlight balls from position k-1 onwards
                                    setTimeout(() => {
                                        ball.classList.add('highlight');
                                        setTimeout(() => ball.classList.remove('highlight'), 500);
                                    }, delay);
                                    delay += 30;
                                }
                            });
                        } else {
                            // Normal case: highlight first 'count' balls
                            const count = ballsConfig.count || balls.length;
                            balls.forEach((ball, index) => {
                                if (index < count) {
                                    setTimeout(() => {
                                        ball.classList.add('highlight');
                                        setTimeout(() => ball.classList.remove('highlight'), 500);
                                    }, delay);
                                    delay += 30;
                                }
                            });
                        }
                    }
                }
            });
        }

        function generateExplanation(n, k, method) {
            stepCounter = 0; // Reset counter
            const result = solve(n, k);
            let steps = '';
            let description = '';

            // Calculate sum of 1 to k-1
            let sumSmallNumbers = 0;
            for (let i = 1; i < k; i++) {
                sumSmallNumbers += i;
            }
            const numbersWithEnough = n - k + 1;
            const ballsFromLargeNumbers = numbersWithEnough * (k - 1);

            if (method === 1) {
                // Ph∆∞∆°ng √°n 1: Nguy√™n l√Ω Dirichlet (Pigeonhole Principle)
                description = `<strong>Nguy√™n l√Ω Dirichlet:</strong> N·∫øu ph√¢n ph·ªëi m ƒë·ªëi t∆∞·ª£ng v√†o n h·ªôp v√† m > n√ók, th√¨ t·ªìn t·∫°i √≠t nh·∫•t m·ªôt h·ªôp ch·ª©a h∆°n k ƒë·ªëi t∆∞·ª£ng. ·ªû ƒë√¢y, ta coi m·ªói s·ªë nh∆∞ m·ªôt "h·ªôp" v√† t√¨m s·ªë bi t·ªëi thi·ªÉu ƒë·ªÉ ƒë·∫£m b·∫£o m·ªôt h·ªôp c√≥ k bi.`;

                let step1Content = `C√°c s·ªë t·ª´ 1 ƒë·∫øn ${k-1} kh√¥ng bao gi·ªù c√≥ ${k} vi√™n bi.<br>`;
                step1Content += `Trong tr∆∞·ªùng h·ª£p x·∫•u nh·∫•t, ta r√∫t h·∫øt t·∫•t c·∫£: ${sumSmallNumbers} vi√™n bi`;
                let step1Anim = `üí° <strong>Animation:</strong> T∆∞·ªüng t∆∞·ª£ng r√∫t l·∫ßn l∆∞·ª£t c√°c bi t·ª´ s·ªë 1, 2, 3... ƒë·∫øn ${k-1}. T·ªïng c·ªông ${sumSmallNumbers} vi√™n bi ƒë∆∞·ª£c r√∫t ra.`;
                let step1Balls = { range: [1, k-1] }; // Highlight all balls from 1 to k-1
                steps += createStep('B∆∞·ªõc 1: Lo·∫°i b·ªè c√°c s·ªë kh√¥ng ƒë·ªß ƒëi·ªÅu ki·ªán', step1Content, step1Anim, step1Balls);

                let step2Content = `C√≤n l·∫°i ${numbersWithEnough} "h·ªôp" (s·ªë ${k} ƒë·∫øn ${n}).<br>`;
                step2Content += `ƒê·ªÉ ƒë·∫£m b·∫£o m·ªôt h·ªôp c√≥ ${k} bi, tr∆∞·ªùng h·ª£p x·∫•u nh·∫•t l√† m·ªói h·ªôp c√≥ ${k-1} bi:<br>`;
                step2Content += `${numbersWithEnough} h·ªôp √ó ${k-1} bi = ${ballsFromLargeNumbers} vi√™n bi`;
                let step2Anim = `üéØ <strong>Animation:</strong> T·ª´ m·ªói s·ªë ${k}, ${k+1}, ..., ${n}, r√∫t ${k-1} vi√™n bi. M·ªói h·ªôp c√≤n thi·∫øu 1 vi√™n ƒë·ªÉ ƒë·ªß ${k} vi√™n.`;
                let step2Balls = { range: [k, n], count: k-1 }; // Highlight first k-1 balls from each number k to n
                steps += createStep('B∆∞·ªõc 2: √Åp d·ª•ng nguy√™n l√Ω Dirichlet', step2Content, step2Anim, step2Balls);

                let step3Content = `Vi√™n bi th·ª© ${sumSmallNumbers + ballsFromLargeNumbers + 1} ch·∫Øc ch·∫Øn r∆°i v√†o m·ªôt h·ªôp ƒë√£ c√≥ ${k-1} bi,<br>`;
                step3Content += `t·∫°o th√†nh ${k} vi√™n bi c√πng s·ªë! üéØ<br><br>`;
                step3Content += `<strong>C√¥ng th·ª©c:</strong> ${sumSmallNumbers} + ${ballsFromLargeNumbers} + 1 = <strong>${result} vi√™n bi</strong>`;
                let step3Anim = `‚ú® <strong>ƒêi·ªÉm then ch·ªët:</strong> Vi√™n bi ti·∫øp theo B·∫ÆT BU·ªòC ph·∫£i r∆°i v√†o m·ªôt trong ${numbersWithEnough} h·ªôp, l√†m h·ªôp ƒë√≥ c√≥ ƒë·ªß ${k} vi√™n!`;
                let step3Balls = { range: [k, n], count: k }; // Highlight k balls from each number k to n
                steps += createStep('B∆∞·ªõc 3: Bi quy·∫øt ƒë·ªãnh', step3Content, step3Anim, step3Balls);

            } else if (method === 2) {
                // Ph∆∞∆°ng √°n 2: Ph√¢n t√≠ch t·ª´ng nh√≥m
                description = `<strong>Ph∆∞∆°ng ph√°p ph√¢n nh√≥m:</strong> Chia c√°c s·ªë th√†nh 2 nh√≥m: nh√≥m "kh√¥ng ƒë·ªß" (1 ƒë·∫øn ${k-1}) v√† nh√≥m "ƒë·ªß" (${k} ƒë·∫øn ${n}). Ph√¢n t√≠ch ri√™ng t·ª´ng nh√≥m trong tr∆∞·ªùng h·ª£p x·∫•u nh·∫•t.`;

                let terms = [];
                for (let i = 1; i < k; i++) {
                    terms.push(i);
                }
                let group1Content = `T·ªïng s·ªë bi trong nh√≥m n√†y:<br>`;
                group1Content += `${terms.join(' + ')} = ${sumSmallNumbers} vi√™n bi<br>`;
                group1Content += `<strong>K·∫øt lu·∫≠n nh√≥m 1:</strong> R√∫t t·ªëi ƒëa ${sumSmallNumbers} vi√™n m√† kh√¥ng c√≥ ${k} vi√™n c√πng s·ªë.`;
                let group1Anim = `üì¶ <strong>Nh√≥m 1:</strong> G·ªìm ${k-1} s·ªë, m·ªói s·ªë c√≥ √≠t h∆°n ${k} vi√™n. R√∫t h·∫øt t·∫•t c·∫£ c≈©ng kh√¥ng ƒë·ªß ƒëi·ªÅu ki·ªán!`;
                let group1Balls = { range: [1, k-1] };
                steps += createStep(`Nh√≥m 1: C√°c s·ªë kh√¥ng ƒë·ªß ƒëi·ªÅu ki·ªán (1 ƒë·∫øn ${k-1})`, group1Content, group1Anim, group1Balls);

                let group2Content = `C√≥ ${numbersWithEnough} s·ªë trong nh√≥m n√†y.<br>`;
                group2Content += `M·ªói s·ªë c√≥ t·ª´ ${k} vi√™n tr·ªü l√™n.<br>`;
                group2Content += `Tr∆∞·ªùng h·ª£p x·∫•u nh·∫•t: r√∫t ${k-1} vi√™n t·ª´ m·ªói s·ªë = ${ballsFromLargeNumbers} vi√™n bi<br>`;
                group2Content += `<strong>K·∫øt lu·∫≠n nh√≥m 2:</strong> R√∫t t·ªëi ƒëa ${ballsFromLargeNumbers} vi√™n m√† kh√¥ng c√≥ ${k} vi√™n c√πng s·ªë.`;
                let group2Anim = `üì¶ <strong>Nh√≥m 2:</strong> G·ªìm ${numbersWithEnough} s·ªë ƒë·ªß ƒëi·ªÅu ki·ªán. R√∫t "g·∫ßn ƒë·ªß" (${k-1} vi√™n) t·ª´ m·ªói s·ªë.`;
                let group2Balls = { range: [k, n], count: k-1 };
                steps += createStep(`Nh√≥m 2: C√°c s·ªë ƒë·ªß ƒëi·ªÅu ki·ªán (${k} ƒë·∫øn ${n})`, group2Content, group2Anim, group2Balls);

                let summaryContent = `T·ªïng bi r√∫t ƒë∆∞·ª£c m√† v·∫´n ch∆∞a c√≥ ${k} vi√™n c√πng s·ªë:<br>`;
                summaryContent += `Nh√≥m 1 + Nh√≥m 2 = ${sumSmallNumbers} + ${ballsFromLargeNumbers} = ${sumSmallNumbers + ballsFromLargeNumbers} vi√™n<br><br>`;
                summaryContent += `R√∫t th√™m 1 vi√™n n·ªØa (vi√™n th·ª© ${result}) ‚Üí Ch·∫Øc ch·∫Øn c√≥ ${k} vi√™n c√πng s·ªë! üéØ<br><br>`;
                summaryContent += `<strong>ƒê√°p √°n:</strong> ${sumSmallNumbers} + ${ballsFromLargeNumbers} + 1 = <strong>${result} vi√™n bi</strong>`;
                let summaryAnim = `üéâ <strong>T·ªïng k·∫øt:</strong> ${sumSmallNumbers} + ${ballsFromLargeNumbers} + 1 = ${result} vi√™n bi`;
                let summaryBalls = { range: [1, n] }; // Show all balls
                steps += createStep('T·ªïng h·ª£p hai nh√≥m', summaryContent, summaryAnim, summaryBalls);

            } else if (method === 3) {
                // Ph∆∞∆°ng √°n 3: C√¥ng th·ª©c t·ªïng qu√°t
                description = `<strong>Ph∆∞∆°ng ph√°p c√¥ng th·ª©c:</strong> S·ª≠ d·ª•ng c√¥ng th·ª©c t·ªïng qu√°t cho b√†i to√°n r√∫t bi. K·∫øt qu·∫£ = Œ£(i=1 to k-1) i + (n-k+1)√ó(k-1) + 1`;

                let formulaContent = `V·ªõi n s·ªë v√† c·∫ßn k bi c√πng s·ªë, c√¥ng th·ª©c l√†:<br>`;
                formulaContent += `<div class="formula">K·∫øt qu·∫£ = Œ£(t·ª´ i=1 ƒë·∫øn k-1) + (n-k+1)√ó(k-1) + 1</div>`;
                formulaContent += `Trong ƒë√≥:<br>`;
                formulaContent += `‚Ä¢ Œ£(t·ª´ i=1 ƒë·∫øn k-1) = t·ªïng bi t·ª´ c√°c s·ªë nh·ªè h∆°n k<br>`;
                formulaContent += `‚Ä¢ (n-k+1) = s·ªë l∆∞·ª£ng c√°c s·ªë ‚â• k<br>`;
                formulaContent += `‚Ä¢ (k-1) = s·ªë bi r√∫t t·ª´ m·ªói s·ªë ‚â• k<br>`;
                formulaContent += `‚Ä¢ +1 = vi√™n bi quy·∫øt ƒë·ªãnh`;
                let formulaAnim = `üìê <strong>C√¥ng th·ª©c t·ªïng qu√°t:</strong> √Åp d·ª•ng cho b·∫•t k·ª≥ gi√° tr·ªã n v√† k n√†o!`;
                steps += createStep('C√¥ng th·ª©c t·ªïng qu√°t', formulaContent, formulaAnim, {});

                let part1Content = `S·ª≠ d·ª•ng c√¥ng th·ª©c t·ªïng d√£y s·ªë: Œ£ = n√ó(n+1)/2<br>`;
                part1Content += `Œ£(t·ª´ 1 ƒë·∫øn ${k-1}) = ${k-1}√ó${k}/2 = ${sumSmallNumbers} vi√™n bi`;
                let part1Anim = `üî¢ <strong>T√≠nh t·ªïng:</strong> 1 + 2 + 3 + ... + ${k-1} = ${sumSmallNumbers}`;
                let part1Balls = { range: [1, k-1] };
                steps += createStep(`T√≠nh ph·∫ßn 1: Œ£(t·ª´ i=1 ƒë·∫øn ${k-1})`, part1Content, part1Anim, part1Balls);

                let part2Content = `S·ªë l∆∞·ª£ng s·ªë ‚â• k: n - k + 1 = ${n} - ${k} + 1 = ${numbersWithEnough}<br>`;
                part2Content += `S·ªë bi r√∫t t·ª´ m·ªói s·ªë: k - 1 = ${k} - 1 = ${k-1}<br>`;
                part2Content += `T√≠ch: ${numbersWithEnough} √ó ${k-1} = ${ballsFromLargeNumbers} vi√™n bi`;
                let part2Anim = `‚úñÔ∏è <strong>T√≠nh t√≠ch:</strong> ${numbersWithEnough} s·ªë √ó ${k-1} vi√™n/s·ªë = ${ballsFromLargeNumbers}`;
                let part2Balls = { range: [k, n], count: k-1 };
                steps += createStep('T√≠nh ph·∫ßn 2: (n-k+1)√ó(k-1)', part2Content, part2Anim, part2Balls);

                let finalContent = `K·∫øt qu·∫£ = Ph·∫ßn 1 + Ph·∫ßn 2 + 1<br>`;
                finalContent += `K·∫øt qu·∫£ = ${sumSmallNumbers} + ${ballsFromLargeNumbers} + 1<br>`;
                finalContent += `<strong>K·∫øt qu·∫£ = ${result} vi√™n bi</strong> üéØ`;
                let finalAnim = `üéä <strong>K·∫øt qu·∫£:</strong> ${sumSmallNumbers} + ${ballsFromLargeNumbers} + 1 = ${result} vi√™n bi!`;
                let finalBalls = { range: [1, n] };
                steps += createStep('T√≠nh k·∫øt qu·∫£ cu·ªëi c√πng', finalContent, finalAnim, finalBalls);

            } else if (method === 4) {
                // Ph∆∞∆°ng √°n 4: ƒê·∫øm ph·∫ßn b√π (Complementary Counting)
                description = `<strong>Ph∆∞∆°ng ph√°p ƒë·∫øm ph·∫ßn b√π:</strong> Thay v√¨ ƒë·∫øm tr·ª±c ti·∫øp, ta t√≠nh t·ªïng t·∫•t c·∫£ c√°c bi trong h·ªôp, sau ƒë√≥ tr·ª´ ƒëi s·ªë bi c√≥ th·ªÉ b·ªè l·∫°i m√† v·∫´n kh√¥ng tho·∫£ m√£n ƒëi·ªÅu ki·ªán.`;

                // T√≠nh t·ªïng t·∫•t c·∫£ bi
                let totalBalls = 0;
                for (let i = 1; i <= n; i++) {
                    totalBalls += i;
                }

                // T√≠nh s·ªë bi c√≥ th·ªÉ b·ªè l·∫°i
                let ballsCanLeave = 0;
                // T·ª´ m·ªói s·ªë >= k, c√≥ th·ªÉ b·ªè l·∫°i (num - k + 1) vi√™n bi
                for (let num = k; num <= n; num++) {
                    ballsCanLeave += (num - k + 1);
                }

                let totalContent = `T·ªïng bi = 1 + 2 + 3 + ... + ${n}<br>`;
                totalContent += `S·ª≠ d·ª•ng c√¥ng th·ª©c: T·ªïng = n√ó(n+1)/2<br>`;
                totalContent += `T·ªïng = ${n}√ó${n+1}/2 = ${totalBalls} vi√™n bi<br><br>`;
                totalContent += `ƒê√¢y l√† s·ªë bi t·ªëi ƒëa c√≥ th·ªÉ r√∫t (r√∫t h·∫øt h·ªôp).`;
                let totalAnim = `üé≤ <strong>T·ªïng s·ªë bi:</strong> N·∫øu r√∫t h·∫øt h·ªôp s·∫Ω c√≥ ${totalBalls} vi√™n bi.`;
                let totalBalls4 = { range: [1, n] }; // Show all balls
                steps += createStep('B∆∞·ªõc 1: T√≠nh t·ªïng t·∫•t c·∫£ bi trong h·ªôp', totalContent, totalAnim, totalBalls4);

                let leaveContent = `ƒê·ªÉ KH√îNG c√≥ ${k} vi√™n bi c√πng s·ªë, m·ªói s·ªë ch·ªâ ƒë∆∞·ª£c r√∫t t·ªëi ƒëa ${k-1} vi√™n.<br><br>`;
                leaveContent += `‚Ä¢ C√°c s·ªë 1 ƒë·∫øn ${k-1}: Ph·∫£i r√∫t h·∫øt (kh√¥ng ƒë·ªß ${k} vi√™n)<br>`;
                leaveContent += `  ‚Üí Kh√¥ng th·ªÉ b·ªè l·∫°i: 0 vi√™n<br><br>`;
                leaveContent += `‚Ä¢ C√°c s·ªë ${k} ƒë·∫øn ${n}: M·ªói s·ªë c√≥ th·ªÉ b·ªè l·∫°i m·ªôt s·ªë vi√™n:<br>`;

                for (let num = k; num <= Math.min(k + 2, n); num++) {
                    leaveContent += `  - S·ªë ${num}: c√≥ ${num} vi√™n, r√∫t t·ªëi ƒëa ${k-1} vi√™n ‚Üí b·ªè l·∫°i ${num - k + 1} vi√™n<br>`;
                }
                if (n > k + 2) leaveContent += `  - ...<br>`;
                if (n > k + 1) leaveContent += `  - S·ªë ${n}: c√≥ ${n} vi√™n, r√∫t t·ªëi ƒëa ${k-1} vi√™n ‚Üí b·ªè l·∫°i ${n - k + 1} vi√™n<br>`;

                leaveContent += `<br>T·ªïng bi c√≥ th·ªÉ b·ªè l·∫°i = `;
                let leaveTerms = [];
                for (let num = k; num <= n; num++) {
                    leaveTerms.push(`${num - k + 1}`);
                }
                leaveContent += leaveTerms.join(' + ') + ` = ${ballsCanLeave} vi√™n bi`;
                let leaveAnim = `üîÑ <strong>ƒê·∫øm ng∆∞·ª£c:</strong> C√≥ ${ballsCanLeave} vi√™n bi c√≥ th·ªÉ B·ªé L·∫†I trong h·ªôp.`;
                // Highlight balls that will be left (the last balls of each number >= k)
                let leaveBalls = { range: [k, n], count: -1 }; // -1 means show the remaining balls
                steps += createStep('B∆∞·ªõc 2: T√≠nh s·ªë bi c√≥ th·ªÉ b·ªè l·∫°i m√† v·∫´n kh√¥ng tho·∫£ m√£n', leaveContent, leaveAnim, leaveBalls);

                let compContent = `S·ªë bi t·ªëi ƒëa c√≥ th·ªÉ r√∫t m√† KH√îNG tho·∫£ m√£n:<br>`;
                compContent += `= T·ªïng t·∫•t c·∫£ bi - S·ªë bi c√≥ th·ªÉ b·ªè l·∫°i<br>`;
                compContent += `= ${totalBalls} - ${ballsCanLeave} = ${totalBalls - ballsCanLeave} vi√™n bi<br><br>`;
                compContent += `ƒê√¢y l√† s·ªë bi t·ªëi ƒëa r√∫t m√† ch∆∞a c√≥ ${k} vi√™n c√πng s·ªë.<br>`;
                compContent += `R√∫t th√™m 1 vi√™n n·ªØa ‚Üí Ch·∫Øc ch·∫Øn c√≥ ${k} vi√™n c√πng s·ªë! üéØ<br><br>`;
                compContent += `<strong>K·∫øt qu·∫£: ${totalBalls - ballsCanLeave} + 1 = ${result} vi√™n bi</strong>`;
                let compAnim = `‚ûñ <strong>Ph·∫ßn b√π:</strong> ${totalBalls} - ${ballsCanLeave} + 1 = ${result} vi√™n bi!`;
                let compBalls = { range: [k, n], count: k }; // Highlight the k balls needed
                steps += createStep('B∆∞·ªõc 3: T√≠nh s·ªë bi ph·∫£i r√∫t (ph·∫ßn b√π)', compContent, compAnim, compBalls);
            }

            document.getElementById('method-description').innerHTML = description;
            document.getElementById('steps').innerHTML = steps;
        }

        function calculate() {
            const n = parseInt(document.getElementById('n').value);
            const k = parseInt(document.getElementById('k').value);

            if (k > n) {
                alert('k kh√¥ng th·ªÉ l·ªõn h∆°n n!');
                return;
            }

            const result = solve(n, k);

            // Show result
            document.getElementById('result-container').style.display = 'block';
            document.getElementById('answer').innerHTML = `<strong>ƒê√°p √°n: ${result} vi√™n bi</strong>`;

            // Generate explanation based on current method
            generateExplanation(n, k, currentMethod);

            // Visualization
            visualize(n, k);
        }

        function visualize(n, k) {
            const container = document.getElementById('balls-container');
            container.innerHTML = '';

            // Numbers that can't have k balls
            if (k > 1) {
                const group1 = document.createElement('div');
                group1.className = 'ball-group';
                group1.innerHTML = `<div class="ball-group-header">C√°c s·ªë 1-${k-1}: R√∫t H·∫æT (kh√¥ng ƒë·ªß ${k} vi√™n)</div>`;
                const balls1 = document.createElement('div');
                balls1.className = 'balls';

                for (let num = 1; num < k; num++) {
                    const row = document.createElement('div');
                    row.className = 'ball-row';

                    const label = document.createElement('span');
                    label.className = 'ball-row-label';
                    label.textContent = `S·ªë ${num}:`;
                    row.appendChild(label);

                    for (let i = 0; i < num; i++) {
                        const ball = document.createElement('div');
                        ball.className = 'ball drawn';
                        ball.textContent = num;
                        row.appendChild(ball);
                    }
                    balls1.appendChild(row);
                }
                group1.appendChild(balls1);
                container.appendChild(group1);
            }

            // Numbers that can have k balls
            const group2 = document.createElement('div');
            group2.className = 'ball-group';
            group2.innerHTML = `<div class="ball-group-header">C√°c s·ªë ${k}-${n}: R√∫t ${k-1} vi√™n t·ª´ m·ªói s·ªë (tr∆∞·ªùng h·ª£p x·∫•u nh·∫•t)</div>`;
            const balls2 = document.createElement('div');
            balls2.className = 'balls';

            for (let num = k; num <= n; num++) {
                const row = document.createElement('div');
                row.className = 'ball-row';

                const label = document.createElement('span');
                label.className = 'ball-row-label';
                label.textContent = `S·ªë ${num}:`;
                row.appendChild(label);

                for (let i = 0; i < num; i++) {
                    const ball = document.createElement('div');
                    if (i < k - 1) {
                        ball.className = 'ball drawn';
                    } else {
                        ball.className = 'ball available';
                    }
                    ball.textContent = num;
                    row.appendChild(ball);
                }
                balls2.appendChild(row);
            }
            group2.appendChild(balls2);
            container.appendChild(group2);

            const note = document.createElement('div');
            note.className = 'explanation';
            note.innerHTML = `
                <strong>Ch√∫ th√≠ch:</strong><br>
                <span class="ball drawn" style="display:inline-flex; width:20px; height:20px; margin:5px;">ƒê·ªè</span> = ƒê√£ r√∫t trong tr∆∞·ªùng h·ª£p x·∫•u nh·∫•t<br>
                <span class="ball available" style="display:inline-flex; width:20px; height:20px; margin:5px;">Xanh</span> = C√≤n l·∫°i (vi√™n bi ti·∫øp theo ƒë·∫£m b·∫£o c√≥ ${k} vi√™n c√πng s·ªë)
            `;
            container.appendChild(note);
        }

        // Initialize on load
        updateProblem();
        calculate();
    </script>
</body>
</html>